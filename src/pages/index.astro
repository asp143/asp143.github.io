---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/home.css';

const currentYear = new Date().getFullYear();
---

<BaseLayout>
  <div class="scroll-dot" aria-hidden="true"></div>

  <main class="portfolio-page">
    <!-- Hero -->
    <section class="hero" id="hero">
      <div class="hero-inner">
        <h1 class="hero-name" aria-label="Ralph Jonas">
          <span class="hero-name-line">
            {'RALPH'.split('').map(letter => (
              <span class="hero-name-letter motion-letter">{letter}</span>
            ))}
          </span>
          <span class="hero-name-line">
            {'JONAS'.split('').map(letter => (
              <span class="hero-name-letter motion-letter">{letter}</span>
            ))}
            <span class="hero-name-letter motion-letter hero-period">.</span>
          </span>
        </h1>
        <p class="hero-subtitle motion-fade">
          Full-Stack Developer &amp; AI Integration Specialist building scalable, practical software.
        </p>
      </div>

      <div class="hero-scroll motion-fade" aria-hidden="true">
        <span class="hero-scroll-text">Scroll</span>
        <span class="hero-scroll-arrow">&#8595;</span>
        <span class="hero-scroll-line"></span>
      </div>
    </section>

    <!-- 01. Projects -->
    <section class="section" id="projects">
      <div class="section-inner">
        <span class="section-number motion-fade">01.</span>
        <h2 class="section-heading motion-fade">Projects</h2>
        <hr class="section-rule" />

        <ul class="project-list">
          <li class="project-row motion-stagger">
            <span class="project-name">Flight Rewards Search Platform</span>
            <span class="project-tech">Node.js · TypeScript · PostgreSQL · GCP</span>
            <p class="project-desc">Technical lead for a UK-based SaaS platform that helps users find and compare reward flight availability across major airlines.</p>
          </li>
          <li class="project-row motion-stagger">
            <span class="project-name">Billing &amp; Payment Platform</span>
            <span class="project-tech">Node.js · TypeScript · GCP · Event-Driven</span>
            <p class="project-desc">Multi-gateway payment orchestration platform with unified subscription billing, dunning management, and smart retry logic.</p>
          </li>
          <li class="project-row motion-stagger">
            <span class="project-name">Airline Data Aggregation Bots</span>
            <span class="project-tech">TypeScript · Puppeteer · BullMQ</span>
            <p class="project-desc">Automated scrapers collecting flight availability data from multiple airline sources on scheduled intervals.</p>
          </li>
          <li class="project-row motion-stagger">
            <span class="project-name">Remote MCP Server</span>
            <span class="project-tech">TypeScript · Node.js · Docker</span>
            <p class="project-desc">Model Context Protocol server accessible via URL, enabling AI assistants to interact with custom tools through SSE transport.</p>
          </li>
          <li class="project-row motion-stagger">
            <span class="project-name">Home Infrastructure Lab</span>
            <span class="project-tech">Docker · Linux · TrueNAS · Tailscale</span>
            <p class="project-desc">Multi-node self-hosted services ecosystem including NAS, media streaming, workflow automation, and monitoring dashboards.</p>
          </li>
        </ul>

        <h3 class="other-heading motion-fade">Other Work</h3>

        <ul class="project-list">
          <li class="compact-row motion-stagger">
            <span class="compact-name">Airline Route Mapping Service</span>
            <span class="compact-tech">TypeScript · Node.js</span>
          </li>
          <li class="compact-row motion-stagger">
            <span class="compact-name">Loyalty Points Transfer Engine</span>
            <span class="compact-tech">Node.js · TypeScript · React</span>
          </li>
          <li class="compact-row motion-stagger">
            <span class="compact-name">Subscription Service Architecture</span>
            <span class="compact-tech">Node.js · GCP · Pub/Sub</span>
          </li>
          <li class="compact-row motion-stagger">
            <span class="compact-name">AI Development Workflow Standards</span>
            <span class="compact-tech">Claude · OpenAI</span>
          </li>
          <li class="compact-row motion-stagger">
            <span class="compact-name">Local AI Inference Server</span>
            <span class="compact-tech">Linux · AI/ML Inference</span>
          </li>
          <li class="compact-row motion-stagger">
            <span class="compact-name">Accident Detection Device</span>
            <span class="compact-tech">Raspberry Pi · Python</span>
          </li>
          <li class="compact-row motion-stagger">
            <span class="compact-name">Accident Detection Control Panel</span>
            <span class="compact-tech">MongoDB · Express · Angular · Node.js</span>
          </li>
          <li class="compact-row motion-stagger">
            <span class="compact-name">Audit &amp; Report Generator</span>
            <span class="compact-tech">Angular · Node.js · SQL · AWS</span>
          </li>
          <li class="compact-row motion-stagger">
            <span class="compact-name">Freelance Projects</span>
            <span class="compact-tech">Upwork</span>
          </li>
        </ul>
      </div>
    </section>

    <!-- 02. About -->
    <section class="section" id="about">
      <div class="section-inner">
        <span class="section-number motion-fade">02.</span>
        <h2 class="section-heading motion-fade">About</h2>
        <hr class="section-rule" />

        <div class="about-grid">
          <div class="about-col-left">
            <span class="about-name motion-fade" aria-label="Ralph Jonas Mungcal">Ralph Jonas</span>
            <p class="about-bio motion-fade">
              Full-stack developer and AI integration specialist based in the Philippines. I build products end-to-end — from backend architecture and cloud infrastructure to developer tooling and AI-powered workflows.
            </p>
            <p class="about-bio motion-fade">
              I focus on writing clean, maintainable systems that solve real problems. Whether it's orchestrating payments across multiple gateways, building data aggregation pipelines, or setting up self-hosted infrastructure — I care about getting the details right.
            </p>
          </div>

          <div class="about-col-right">
            <div class="about-stats">
              <div class="about-stat motion-stagger">
                <span class="about-stat-number">5+</span>
                <span class="about-stat-label">Years Building Software</span>
              </div>
              <div class="about-stat motion-stagger">
                <span class="about-stat-number">10+</span>
                <span class="about-stat-label">Projects Shipped</span>
              </div>
            </div>

            <div class="focus-list">
              <span class="focus-item motion-stagger">Backend Architecture</span>
              <span class="focus-item motion-stagger">AI Integration</span>
              <span class="focus-item motion-stagger">Cloud Infrastructure</span>
              <span class="focus-item motion-stagger">Developer Tooling</span>
            </div>

            <div class="about-stack">
              <span class="about-stack-label motion-fade">Daily drivers</span>
              <div class="about-stack-items">
                <span class="about-stack-item motion-stagger">TypeScript</span>
                <span class="about-stack-item motion-stagger">Node.js</span>
                <span class="about-stack-item motion-stagger">GCP</span>
                <span class="about-stack-item motion-stagger">Docker</span>
                <span class="about-stack-item motion-stagger">PostgreSQL</span>
                <span class="about-stack-item motion-stagger">Linux</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 03. Writing -->
    <section class="section" id="writing">
      <div class="section-inner">
        <span class="section-number motion-fade">03.</span>
        <h2 class="section-heading motion-fade">Writing</h2>
        <hr class="section-rule" />

        <ul class="writing-list">
          <li>
            <a href="https://ralphdev.bearblog.dev/gcp-secrets/" class="writing-row motion-stagger" target="_blank" rel="noopener noreferrer">
              <time class="writing-date">2026.01</time>
              <span class="writing-title">Secure your cloud build secrets</span>
              <span class="writing-arrow" aria-hidden="true">&rarr;</span>
            </a>
          </li>
          <li>
            <a href="https://ralphdev.bearblog.dev/what-is-a-tech-lead/" class="writing-row motion-stagger" target="_blank" rel="noopener noreferrer">
              <time class="writing-date">2024.04</time>
              <span class="writing-title">What is a Tech lead?</span>
              <span class="writing-arrow" aria-hidden="true">&rarr;</span>
            </a>
          </li>
          <li>
            <a href="https://ralphdev.bearblog.dev/discipline-over-motivation/" class="writing-row motion-stagger" target="_blank" rel="noopener noreferrer">
              <time class="writing-date">2023.02</time>
              <span class="writing-title">Discipline over Motivation</span>
              <span class="writing-arrow" aria-hidden="true">&rarr;</span>
            </a>
          </li>
          <li>
            <a href="https://ralphdev.bearblog.dev/google-cloud-developer-certification-guide/" class="writing-row motion-stagger" target="_blank" rel="noopener noreferrer">
              <time class="writing-date">2022.10</time>
              <span class="writing-title">Google Cloud Developer Certification Guide</span>
              <span class="writing-arrow" aria-hidden="true">&rarr;</span>
            </a>
          </li>
        </ul>

        <a href="https://ralphdev.bearblog.dev/" class="writing-view-all motion-fade" target="_blank" rel="noopener noreferrer">
          View all posts <span aria-hidden="true">&rarr;</span>
        </a>
      </div>
    </section>

    <!-- 04. Contact -->
    <section class="section" id="contact">
      <div class="section-inner">
        <span class="section-number motion-fade">04.</span>
        <h2 class="contact-cta motion-fade">
          Let's work<br />together<span class="contact-period">.</span>
        </h2>
        <hr class="section-rule" />

        <div class="contact-links">
          <a href="mailto:ralphmungcal09@gmail.com" class="contact-link motion-stagger">Email</a>
          <a href="https://www.linkedin.com/in/ralphjonasmungcal" class="contact-link motion-stagger" target="_blank" rel="noopener noreferrer">LinkedIn</a>
          <a href="https://www.upwork.com/o/profiles/users/_~01108375a06953763f/" class="contact-link motion-stagger" target="_blank" rel="noopener noreferrer">Upwork</a>
        </div>
      </div>

      <footer class="site-footer">
        Ralph Jonas Mungcal &copy; {currentYear}
      </footer>
    </section>
  </main>

  <script>
    import { animate, inView, stagger, spring } from "https://cdn.jsdelivr.net/npm/motion@12/+esm";

    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (!prefersReducedMotion) {
      // Hero: Stagger letters in
      const heroLetters = document.querySelectorAll('.hero-name-letter');
      animate(
        heroLetters,
        { opacity: [0, 1], transform: ['translateY(100%)', 'translateY(0)'] },
        { duration: 0.6, delay: stagger(0.05), easing: [0.16, 1, 0.3, 1] }
      );

      // Hero subtitle + scroll indicator fade in after name
      const heroFades = document.querySelectorAll('.hero .motion-fade');
      animate(
        heroFades,
        { opacity: [0, 1], transform: ['translateY(20px)', 'translateY(0)'] },
        { duration: 0.8, delay: stagger(0.15, { start: 0.8 }), easing: [0.16, 1, 0.3, 1] }
      );

      // Fade out scroll indicator on scroll + scroll dot animation
      const scrollIndicator = document.querySelector('.hero-scroll') as HTMLElement | null;
      const scrollDot = document.querySelector('.scroll-dot') as HTMLElement | null;
      const heroPeriod = document.querySelector('.hero-period') as HTMLElement | null;
      const contactPeriod = document.querySelector('.contact-period') as HTMLElement | null;
      const hero = document.querySelector('.hero') as HTMLElement | null;
      const sections = document.querySelectorAll('.section');

      if (scrollDot && hero && sections.length) {
        // === State Machine ===
        type DotState = 'hidden' | 'falling' | 'resting' | 'detached';
        let state: DotState = 'hidden';
        let currentIndex = -1;
        let ticking = false;
        let isRolled = false;

        const DETACH_THRESHOLD = 60;
        const TRIGGER_RATIO = 0.4;

        function getHeading(index: number): HTMLElement | null {
          const section = sections[index] as HTMLElement;
          return section?.querySelector('.section-heading, .contact-cta') as HTMLElement | null;
        }

        function getHeadingY(index: number): number {
          const heading = getHeading(index);
          if (heading) {
            const rect = heading.getBoundingClientRect();
            return rect.top + rect.height / 2;
          }
          const section = sections[index] as HTMLElement;
          return section.offsetTop - window.scrollY + 32;
        }

        function getActiveIndex(): number {
          const triggerY = window.scrollY + window.innerHeight * TRIGGER_RATIO;
          let active = 0;
          sections.forEach((section, i) => {
            if (triggerY >= (section as HTMLElement).offsetTop) {
              active = i;
            }
          });
          return Math.min(active, sections.length - 1);
        }

        function clearStateClasses() {
          scrollDot.classList.remove(
            'scroll-dot--falling', 'scroll-dot--detached',
            'scroll-dot--bouncing', 'scroll-dot--rolling', 'scroll-dot--settled'
          );
        }

        function resetRolling() {
          if (isRolled) {
            isRolled = false;
            scrollDot.classList.remove('scroll-dot--rolling', 'scroll-dot--settled');
            scrollDot.style.left = '50%';
            scrollDot.style.transform = 'translateX(-50%)';
            scrollDot.style.opacity = '';
            if (contactPeriod) contactPeriod.style.opacity = '';
          }
        }

        function startFall(targetIndex: number) {
          state = 'falling';
          currentIndex = targetIndex;

          if (targetIndex < sections.length - 1) resetRolling();

          clearStateClasses();
          scrollDot.classList.add('scroll-dot--falling');

          // Force reflow so transition triggers from current position
          void scrollDot.offsetHeight;

          const targetY = getHeadingY(targetIndex);
          scrollDot.style.top = `${targetY}px`;
        }

        // Fall complete → bounce
        scrollDot.addEventListener('transitionend', (e) => {
          if (e.propertyName !== 'top' || state !== 'falling') return;

          scrollDot.classList.remove('scroll-dot--falling');
          scrollDot.classList.add('scroll-dot--bouncing');

          // Contact section: schedule roll to period after bounce
          const isLastSection = currentIndex === sections.length - 1;
          if (isLastSection && contactPeriod) {
            setTimeout(() => {
              const periodRect = contactPeriod.getBoundingClientRect();
              const periodCenterX = periodRect.left + periodRect.width / 2;
              const periodCenterY = periodRect.top + periodRect.height / 2;

              scrollDot.classList.add('scroll-dot--rolling');
              scrollDot.style.left = `${periodCenterX}px`;
              scrollDot.style.top = `${periodCenterY}px`;
              scrollDot.style.transform = 'translate(-50%, -50%)';

              setTimeout(() => {
                scrollDot.classList.add('scroll-dot--settled');
                scrollDot.style.opacity = '0';
                if (contactPeriod) contactPeriod.style.opacity = '1';
                isRolled = true;
                state = 'resting';
              }, 550);
            }, 650);
          }
        });

        // Bounce complete → resting
        scrollDot.addEventListener('animationend', (e) => {
          if ((e as AnimationEvent).animationName !== 'ball-bounce') return;
          scrollDot.classList.remove('scroll-dot--bouncing');

          // Don't override contact roll sequence
          if (currentIndex === sections.length - 1 && contactPeriod) return;

          state = 'resting';
          clearStateClasses();
        });

        const onScroll = () => {
          if (ticking) return;
          ticking = true;

          requestAnimationFrame(() => {
            const scrollY = window.scrollY;
            const heroBottom = hero.offsetHeight * 0.7;

            // Fade scroll indicator
            if (scrollIndicator) {
              const fade = Math.max(1 - scrollY / (window.innerHeight * 0.3), 0);
              scrollIndicator.style.opacity = String(fade);
            }

            // === HIDDEN: in hero area ===
            if (scrollY <= heroBottom) {
              if (state !== 'hidden') {
                state = 'hidden';
                currentIndex = -1;
                clearStateClasses();
                scrollDot.classList.remove('scroll-dot--visible');
                scrollDot.style.left = '50%';
                scrollDot.style.transform = 'translateX(-50%)';
                scrollDot.style.top = '60px';
                if (heroPeriod) heroPeriod.style.opacity = '';
                if (contactPeriod) contactPeriod.style.opacity = '';
                resetRolling();
              }
              ticking = false;
              return;
            }

            // Past hero — show dot
            scrollDot.classList.add('scroll-dot--visible');
            if (heroPeriod) heroPeriod.style.opacity = '0';

            const activeIndex = getActiveIndex();

            // === HIDDEN → first fall ===
            if (state === 'hidden') {
              scrollDot.style.top = `${DETACH_THRESHOLD}px`;
              void scrollDot.offsetHeight;
              startFall(activeIndex);
              ticking = false;
              return;
            }

            // === RESTING: track heading ===
            if (state === 'resting' && !isRolled) {
              const heading = getHeading(currentIndex);
              if (heading) {
                const headingY = heading.getBoundingClientRect().top + heading.getBoundingClientRect().height / 2;
                scrollDot.style.top = `${headingY}px`;

                if (headingY < DETACH_THRESHOLD) {
                  state = 'detached';
                  scrollDot.style.top = `${DETACH_THRESHOLD}px`;
                  clearStateClasses();
                  scrollDot.classList.add('scroll-dot--detached');
                }
              }

              if (activeIndex < currentIndex) {
                startFall(activeIndex);
              }
            }

            // === DETACHED: wait for next section ===
            else if (state === 'detached') {
              const prevIndex = currentIndex;
              const nextIndex = currentIndex + 1;

              if (nextIndex < sections.length && activeIndex >= nextIndex) {
                startFall(nextIndex);
              } else {
                // Only check re-attach if we did NOT start a fall
                const heading = getHeading(prevIndex);
                if (heading) {
                  const headingY = heading.getBoundingClientRect().top + heading.getBoundingClientRect().height / 2;
                  if (headingY >= DETACH_THRESHOLD) {
                    state = 'resting';
                    clearStateClasses();
                    scrollDot.style.top = `${headingY}px`;
                  }
                }
              }
            }

            // === FALLING: redirect if section changed mid-fall ===
            else if (state === 'falling') {
              if (activeIndex !== currentIndex) {
                currentIndex = activeIndex;
                const targetY = getHeadingY(activeIndex);
                scrollDot.style.top = `${targetY}px`;
              }
            }

            ticking = false;
          });
        };

        window.addEventListener('scroll', onScroll, { passive: true });
      } else if (scrollIndicator) {
        // Fallback: just fade the scroll indicator
        window.addEventListener('scroll', () => {
          const fade = Math.max(1 - window.scrollY / (window.innerHeight * 0.3), 0);
          scrollIndicator.style.opacity = String(fade);
        }, { passive: true });
      }

      // Section headers: fade in on scroll
      document.querySelectorAll('.section').forEach((section) => {
        inView(section, () => {
          const fades = section.querySelectorAll('.motion-fade');
          animate(
            fades,
            { opacity: [0, 1], transform: ['translateY(20px)', 'translateY(0)'] },
            { duration: 0.6, delay: stagger(0.1), easing: [0.16, 1, 0.3, 1] }
          );
        }, { amount: 0.1 });
      });

      // Staggered list items: project rows, writing rows, focus items, contact links
      document.querySelectorAll('.section').forEach((section) => {
        inView(section, () => {
          const items = section.querySelectorAll('.motion-stagger');
          animate(
            items,
            { opacity: [0, 1], transform: ['translateY(16px)', 'translateY(0)'] },
            { duration: 0.5, delay: stagger(0.06), easing: [0.16, 1, 0.3, 1] }
          );
        }, { amount: 0.05 });
      });
    } else {
      // Reduced motion: just show everything
      document.querySelectorAll('.motion-fade, .motion-letter, .motion-stagger').forEach((el) => {
        (el as HTMLElement).style.opacity = '1';
        (el as HTMLElement).style.transform = 'none';
      });
    }
  </script>
</BaseLayout>
